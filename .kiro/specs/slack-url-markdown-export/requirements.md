# 要件定義: SlackメッセージエクスポートにMarkdown形式URL保存機能

## 概要

Slackメッセージをエクスポートするユーザーとして、メッセージ内の外部URLリンクをMarkdown形式で保存できる機能がほしい、なぜならエクスポートしたTSVファイル内でもリンク情報を失わず、他のツール（Obsidian等）で活用できるから。

## ビジネス価値

### 価値提供
- エクスポートしたメッセージ内のURL情報を保持し、後から参照先にアクセス可能にする
- Obsidianなどのマークダウン対応ツールでリンクをそのまま活用可能
- エクスポートしたデータの情報価値が向上
- 外部ツールとの連携が容易

### 測定方法
- URLリンク付きメッセージのエクスポート成功率: 100%
- Markdown形式でのURL保存率: 対象メッセージの100%
- ユーザーフィードバック: Obsidian等でのリンク活用事例

## 機能要件

### 1. 外部URLリンクのMarkdown形式エクスポート
メッセージ内の外部URL（http/https）を`[リンク名](URL)`形式でTSVに保存する。

**受け入れ基準**:
- 外部URL（http/https）が`[リンク名](URL)`のMarkdown形式でTSVに保存される
- URLはhttp/httpsで始まる外部リンクのみ対象

### 2. 複数URLリンクの処理
1つのメッセージに複数のURLリンクが含まれる場合、全てのURLをMarkdown形式で保存する。

**受け入れ基準**:
- 複数のURLが含まれる場合、全てのURLがMarkdown形式で保存される

### 3. 内部リンクの除外
内部リンク（チャンネル、ユーザーメンション等）はMarkdown変換の対象外とする。

**受け入れ基準**:
- 内部リンク（チャンネル、ユーザーメンション等）はMarkdown変換の対象外
- 内部リンクはテキストとして保存される

### 4. 後方互換性の維持
URLリンクがないメッセージは既存動作と同じ挙動を維持する。

**受け入れ基準**:
- URLリンクがないメッセージは既存動作と同じ（後方互換性）
- TSVフォーマットは既存形式を維持（日時\tチャンネル\t送信者\tメッセージ本文）

### 5. 特殊文字のエスケープ処理
特殊文字を含むURLも正しくエスケープして保存する。

**受け入れ基準**:
- 特殊文字を含むURLも正しくエスケープして保存される

## 非機能要件

### 6. パフォーマンス
大量メッセージのエクスポートでも許容可能な速度を維持する。

**受け入れ基準**:
- 100件のメッセージで5秒以内にエクスポート完了

### 7. ブラウザ互換性
主要ブラウザでの動作を保証する。

**受け入れ基準**:
- Chrome、Firefox、Safariでの動作確認完了

### 8. データ整合性
TSV形式のタブ・改行文字のエスケープ処理を正しく行う。

**受け入れ基準**:
- TSVファイルが壊れない（タブ・改行文字の適切なエスケープ）

### 9. セキュリティ
XSS攻撃を防ぐための適切なエスケープ処理を行う。

**受け入れ基準**:
- `.textContent`使用によるXSS対策が実装されている

## BDD受け入れシナリオ

### シナリオ1: 外部URLリンクを含むメッセージをエクスポート
```gherkin
Given Slack検索結果に外部URLリンクを含むメッセージがある
And メッセージ内のURLが<a>タグとして表示されている
When ブックマークレットを実行してメッセージをエクスポートする
Then TSVのメッセージ本文に[リンク名](URL)形式でURLが保存される
And URLはhttp/httpsで始まる外部リンクのみ対象
```

### シナリオ2: 複数の外部URLリンクを含むメッセージ
```gherkin
Given メッセージに複数の外部URLリンクが含まれている
When ブックマークレットを実行してエクスポートする
Then 全ての外部URLが[リンク名](URL)形式で保存される
```

### シナリオ3: 外部URLリンクがないメッセージ
```gherkin
Given メッセージにURLリンクが含まれていない
When ブックマークレットを実行してエクスポートする
Then メッセージ本文がそのまま保存される（既存動作を維持）
```

### シナリオ4: 内部リンクは除外
```gherkin
Given メッセージに内部リンク（#channel、@user）と外部URLが混在
When ブックマークレットを実行してエクスポートする
Then 外部URL（http/https）のみMarkdown形式で保存される
And 内部リンクはテキストとして保存される
```

## 制約条件

### 技術的制約
- 既存のブックマークレット実装を拡張（新規依存関係なし）
- Vanilla JavaScript（フレームワーク不使用）
- ブラウザネイティブAPI のみ使用

### ビジネス的制約
- 既存のTSVフォーマットを維持
- 既存機能への影響を最小限に抑える

## リスクと軽減策

### リスク1: SlackのDOM構造変更
- **影響**: セレクタが無効になりリンク抽出失敗
- **軽減策**: 複数のセレクタパターンを用意、エラーハンドリング

### リスク2: 特殊文字を含むURLのエスケープ漏れ
- **影響**: TSVファイルの破損、Markdown形式の崩れ
- **軽減策**: 単体テストで境界値テスト、エスケープ関数の強化

### リスク3: パフォーマンス劣化
- **影響**: 大量メッセージのエクスポートが遅延
- **軽減策**: パフォーマンステスト実施、必要に応じて最適化

## エッジケース

- リンクテキストが重複する場合の置換順序
- 特殊文字を含むURL（`[]()` エスケープ）
- 非常に長いURL（TSVのセル制限）
- 無効なURLフォーマット（壊れたリンク）

## 参考資料

- [Markdown記法ガイド](https://www.markdownguide.org/basic-syntax/)
- PBI: `pbi/slack-url-markdown-export.md`
