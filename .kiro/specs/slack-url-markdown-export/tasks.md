# 実装タスク: SlackメッセージエクスポートにMarkdown形式URL保存機能

## タスク一覧

### 1. URL抽出機能の実装
- [x] 1.1 (P) 外部URLリンク抽出関数の実装
  - DOM要素から`<a>`タグを取得する処理を実装
  - `href`属性が`http`または`https`で始まるリンクのみフィルタリング
  - リンクテキスト（`textContent`）とURL（`href`）のペアを配列で返却
  - _Requirements: 1, 3_

- [x] 1.2 (P) URL抽出のエッジケース処理
  - リンク要素が存在しない場合は空配列を返却
  - 内部リンク（相対パス、`mailto:`等）を除外
  - null/undefinedの安全な処理
  - _Requirements: 1, 3, 4_

### 2. Markdown変換機能の実装
- [x] 2.1 (P) Markdown形式変換関数の実装
  - リンクテキストとURLから`[text](url)`形式の文字列を生成
  - メッセージ内のリンクテキストを検索してMarkdown形式に置換
  - 正規表現による安全な置換処理（`escapeRegExp`活用）
  - _Requirements: 1, 2_

- [x] 2.2 (P) Markdown変換のエッジケース処理
  - 複数リンクの全置換（グローバルフラグ`g`使用）
  - リンクテキストに特殊文字が含まれる場合のエスケープ処理
  - リンクテキストが重複する場合の処理
  - 空のリンク配列の場合は元のメッセージをそのまま返却
  - _Requirements: 1, 2, 5_

### 3. 既存メッセージ抽出処理の統合
- [x] 3.1 既存`createPromiseGetMessages`関数の修正
  - メッセージ要素（`messageElement`）を取得
  - `extractExternalLinks`関数を呼び出してリンク情報を取得
  - `convertMessageWithMarkdownLinks`関数を呼び出してMarkdown変換
  - 変換後のメッセージを既存の整形処理（送信者名・タイムスタンプ削除）に渡す
  - _Requirements: 1, 2, 4_

- [x] 3.2 後方互換性の検証
  - リンクなしメッセージが既存動作と同じ結果になることを確認
  - TSVフォーマット（日時\tチャンネル\t送信者\tメッセージ本文）が維持されることを確認
  - _Requirements: 4_

### 4. デバッグログの追加
- [x] 4.1 (P) URL抽出とMarkdown変換のログ出力
  - 抽出した外部リンク数をログ出力
  - Markdown変換前後のメッセージをログ出力（`enableDebugMode`時のみ）
  - エラー発生時のログ出力
  - _Requirements: 1, 2_

### 5. 単体テストの実装
- [x] 5.1 (P) `extractExternalLinks`関数のテスト
  - リンクなし要素のテスト
  - 外部URLのみフィルタリングのテスト
  - 内部リンク除外のテスト
  - null/undefined処理のテスト
  - _Requirements: 1, 3_

- [x] 5.2 (P) `convertMessageWithMarkdownLinks`関数のテスト
  - 単一リンクの置換テスト
  - 複数リンクの置換テスト
  - リンクテキスト重複時の処理テスト
  - 特殊文字を含むリンクテキストのテスト
  - 空配列の処理テスト
  - _Requirements: 1, 2, 5_

### 6. 統合テストの実装
- [x] 6.1 (P) DOM操作と関数連携のテスト
  - モックDOM要素からのリンク抽出テスト
  - 外部/内部リンクのフィルタリングテスト
  - 複数リンクの処理テスト
  - リンクなし要素の処理テスト
  - _Requirements: 1, 2, 3_

### 7. E2Eテストの実装
- [x] 7.1 実際のSlackページでのエクスポートテスト
  - 単一外部URLリンクを含むメッセージのエクスポート
  - 複数外部URLリンクを含むメッセージのエクスポート
  - 内部リンクと外部URLが混在するメッセージのエクスポート
  - URLリンクなしメッセージの後方互換性確認
  - _Requirements: 1, 2, 3, 4_

### 8. パフォーマンステスト
- [x] 8.1 (P) 大量メッセージのエクスポート性能確認
  - 100件のメッセージで5秒以内のエクスポート完了を確認
  - 必要に応じて最適化（正規表現キャッシュ等）
  - _Requirements: 6_

### 9. ブラウザ互換性テスト
- [ ] 9.1 (P) 主要ブラウザでの動作確認
  - Chrome での動作確認
  - Firefox での動作確認
  - Safari での動作確認
  - _Requirements: 7_
  - **準備完了**: テストドキュメント作成済み（`BROWSER-COMPATIBILITY-TEST.md`, `MANUAL-TEST-EXECUTION-GUIDE.md`）
  - **実行待ち**: 実際のSlack環境での手動テスト実行が必要

### 10. セキュリティとデータ整合性の検証
- [ ] 10.1 (P) セキュリティとエスケープ処理の確認
  - `.textContent`使用によるXSS対策の確認
  - TSV形式のタブ・改行文字エスケープ処理の確認
  - 特殊文字を含むURLのエスケープ処理の確認
  - _Requirements: 5, 8, 9_
  - **準備完了**: セキュリティ検証ドキュメント作成済み（`SECURITY-VALIDATION.md`, `MANUAL-TEST-EXECUTION-GUIDE.md`）
  - **コードレビュー完了**: XSS対策、正規表現エスケープの実装を確認済み
  - **実行待ち**: 実際のSlack環境での手動検証が必要

## 要件カバレッジ

| 要件ID | タスク |
|--------|--------|
| 1 | 1.1, 1.2, 2.1, 2.2, 3.1, 4.1, 5.1, 5.2, 6.1, 7.1 |
| 2 | 2.1, 2.2, 3.1, 4.1, 5.2, 6.1, 7.1 |
| 3 | 1.1, 1.2, 5.1, 6.1, 7.1 |
| 4 | 1.2, 3.1, 3.2, 7.1 |
| 5 | 2.2, 5.2, 10.1 |
| 6 | 8.1 |
| 7 | 9.1 |
| 8 | 10.1 |
| 9 | 10.1 |

## タスク実行順序の推奨

### Phase 1: コア機能実装（並列可能）
- 1.1, 1.2: URL抽出機能
- 2.1, 2.2: Markdown変換機能
- 4.1: デバッグログ

### Phase 2: 統合（依存関係あり）
- 3.1: 既存関数への統合（1.1, 1.2, 2.1, 2.2 完了後）
- 3.2: 後方互換性検証（3.1 完了後）

### Phase 3: テスト（並列可能）
- 5.1, 5.2: 単体テスト
- 6.1: 統合テスト
- 7.1: E2Eテスト
- 8.1: パフォーマンステスト
- 9.1: ブラウザ互換性テスト
- 10.1: セキュリティ検証

## 見積もり

- **合計タスク数**: 10メジャータスク、15サブタスク
- **見積もり時間**: 約15-20時間
- **完了予定**: 1スプリント内（2週間）
