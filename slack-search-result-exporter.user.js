javascript:(function(){"use strict";const enableDebugMode=true;const log=(value)=>{if(enableDebugMode===true){console.log(value);}};const getMessage=(messagePack)=>{log(">>> getMessage");if(!messagePack.hasNextPage){log("exportMessage::messagePack.hasNextPage = "+messagePack.hasNextPage);showMessagesPopup(messagePack);return;}(async()=>{await createPromiseWaitSearchResult();do{await createPromiseWaitMillisecond(800);await createPromiseGetMessages(messagePack);}while(messagePack.messagePushed===true);await createPromiseClickNextButton(messagePack);await createPromiseWaitMillisecond(600);await createPromiseCheckOutOfPageLimit(messagePack);await getMessage(messagePack);})();};const createPromiseWaitSearchResult=()=>{log(">>> createPromiseWaitSearchResult");const selector=".c-search_message__content";const messageGroupSelector=".c-message_group";const messageTimestampSelector=".c-timestamp";const messageTimestampAttributeKey="data-ts";const observeFunc=()=>{let messageGroups=document.querySelectorAll(messageGroupSelector);let completed=true;messageGroups.forEach((messageGroup)=>{let timestampElm=messageGroup.querySelector(messageTimestampSelector);if(!timestampElm){completed=false;return;}let timestampAttributeValue=timestampElm.getAttribute(messageTimestampAttributeKey);if(!timestampAttributeValue){completed=false;}});const el=document.querySelector(selector);if(el&&completed){return el;}return null;};return new Promise((resolve)=>{let observedElement=observeFunc();if(observedElement!==null){resolve(observedElement);}new MutationObserver((mutationRecords,observer)=>{let observedElement=observeFunc();if(observedElement!==null){resolve(observedElement);observer.disconnect();}}).observe(document.documentElement,{childList:true,subtree:true});});};const createPromiseGetMessages=async(messagePack)=>{log(">>> createPromiseGetMessages");const messageGroupSelector='[role="document"]';const messageContentSelector=".c-search_message__content";const messageTimestampSelector=".c-timestamp";const messageTimestampAttributeKey="data-ts";const channelNameSelector='[data-qa="inline_channel_entity__name"]';const messageSenderSelector=".c-message__sender_button";const timestampLabelSelector=".c-timestamp__label";return new Promise((resolve)=>{messagePack.messagePushed=false;let messageGroups=document.querySelectorAll(messageGroupSelector);log("createPromiseGetMessages | Promise | messageGroups.length = "+messageGroups.length);messageGroups.forEach((messageGroup)=>{const datetime=timestampToTime(messageGroup.querySelector(messageTimestampSelector).getAttribute(messageTimestampAttributeKey).split(".")[0]);const channelNameDom=messageGroup.querySelector(channelNameSelector);let channelName=channelNameDom==null?"DirectMessage":channelNameDom.textContent;const messageSender=messageGroup.querySelector(messageSenderSelector).textContent;const timestampLabel=messageGroup.querySelector(timestampLabelSelector).textContent;const messageElement=messageGroup.querySelector(messageContentSelector);if(!messageElement){log("createPromiseGetMessages | messageElement not found, skipping");return;}const messageClone=messageElement.cloneNode(true);const previewSelectors=['.c-link__label','.c-message_attachment','.c-search_message__attachments','.c-search_message__attachment','.c-message__unfurl','.c-file_attachment','.c-message__img_attachment','[data-qa="message_attachment"]','.c-message_kit__attachment','.c-message_kit__file'];previewSelectors.forEach(selector=>{const elements=messageClone.querySelectorAll(selector);elements.forEach(el=>el.remove());});const brTags=messageClone.querySelectorAll('br');brTags.forEach(br=>{br.replaceWith(document.createTextNode('\n'));});const message=messageClone.textContent;const externalLinks=extractExternalLinks(messageClone);log("createPromiseGetMessages | Extracted "+externalLinks.length+" external links");log("createPromiseGetMessages | Message before conversion: "+message);const messageWithMarkdownLinks=convertMessageWithMarkdownLinks(message,externalLinks);log("createPromiseGetMessages | Message after conversion: "+messageWithMarkdownLinks);const removeMessageSender=new RegExp('^'+escapeRegExp(messageSender));const removeTimestampLabel=new RegExp('^.*?'+timestampLabel);let trimmedMessage=messageWithMarkdownLinks.replace(removeMessageSender,'').replace(removeTimestampLabel,'');trimmedMessage=trimmedMessage.replace(/\n/g,'<br>');const timeAndMessage=datetime+"\t"+channelName+"\t"+messageSender+"\t"+trimmedMessage;log("createPromiseGetMessages | Promise | messageGroups.forEach | "+[datetime,channelName,messageSender,timestampLabel,message].join(", "));log("createPromiseGetMessages | Promise | messageGroups.forEach | "+timeAndMessage);if(messagePack.messageSet.has(timeAndMessage)){log("createPromiseGetMessages | Promise | messagePack.messageSet.has(timeAndMessage) === true | "+timeAndMessage);return;}messagePack.messages.push(timeAndMessage);messagePack.messagePushed=true;messagePack.messageSet.add(timeAndMessage);messageGroup.scrollIntoView();});resolve(messagePack);});};const createPromiseClickNextButton=(messagePack)=>{log(">>> createPromiseClickNextButton");const arrowBtnElements=document.querySelectorAll(".c-pagination__arrow_btn");let nextArrowBtnElement=null;messagePack.hasNextPage=false;if(arrowBtnElements.length===0){return new Promise((resolve)=>{resolve(messagePack);});}arrowBtnElements.forEach((e)=>{if(["Next page","次のページ"].includes(e.getAttribute("aria-label"))){nextArrowBtnElement=e;}});if(!nextArrowBtnElement){log("createPromiseClickNextButton | Next page button not found.");return new Promise((resolve)=>{resolve(messagePack);});}messagePack.hasNextPage=nextArrowBtnElement.attributes["aria-disabled"].value==='false';if(!messagePack.hasNextPage){log("createPromiseClickNextButton | messagePack.hasNextPage = "+messagePack.hasNextPage);return new Promise((resolve)=>{resolve(messagePack);});}return new Promise((resolve)=>{log("createPromiseClickNextButton | Promise | click()");nextArrowBtnElement.click();resolve(messagePack);});};const createPromiseCheckOutOfPageLimit=(messagePack)=>{log(">>> createPromiseCheckOutOfPageLimit");const selector=".c-search_message__content";let el=document.querySelector(selector);if(el===null){messagePack.hasNextPage=false;}return new Promise((resolve)=>{resolve(messagePack);});};const createPromiseWaitMillisecond=(millisecond)=>{return new Promise(resolve=>setTimeout(resolve,millisecond));};const timestampToTime=(timestamp)=>{const d=new Date(timestamp*Math.pow(10,13-timestamp.length));const weekday=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];const yyyy=d.getFullYear();const mm=("0"+(d.getMonth()+1)).slice(-2);const dd=("0"+d.getDate()).slice(-2);const hh=("0"+d.getHours()).slice(-2);const mi=("0"+d.getMinutes()).slice(-2);const ss=("0"+d.getSeconds()).slice(-2);const week=weekday[d.getDay()];return `${yyyy}-${mm}-${dd} ${week} ${hh}:${mi}:${ss}`;};const escapeRegExp=(stringValue)=>{return stringValue.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');};const extractExternalLinks=(element)=>{log(">>> extractExternalLinks");if(!element){log("extractExternalLinks | element is null or undefined");return[];}const links=element.querySelectorAll('a');log("extractExternalLinks | Found "+links.length+" total links");const externalLinks=Array.from(links).filter(link=>{if(!/^https?:\/\//.test(link.href)){return false;}if(/^https?:\/\/[^/]+\.slack\.com\//.test(link.href)){return false;}return true;}).map(link=>{let linkText='';for(let node of link.childNodes){if(node.nodeType===Node.TEXT_NODE){linkText+=node.textContent;}}if(!linkText.trim()){linkText=link.textContent.trim();}return{text:linkText.trim(),url:link.href};});log("extractExternalLinks | Filtered to "+externalLinks.length+" external links");return externalLinks;};const convertMessageWithMarkdownLinks=(message,links)=>{log(">>> convertMessageWithMarkdownLinks");if(!links||links.length===0){log("convertMessageWithMarkdownLinks | No links to convert");return message;}log("convertMessageWithMarkdownLinks | Converting "+links.length+" links");let result=message;links.forEach((link,index)=>{if(!link.text||!link.url){log("convertMessageWithMarkdownLinks | Skipping invalid link at index "+index);return;}const markdownLink="["+link.text+"]("+link.url+")";const escapedText=escapeRegExp(link.text);const regex=new RegExp(escapedText,'g');result=result.replace(regex,markdownLink);log("convertMessageWithMarkdownLinks | Replaced '"+link.text+"' with '"+markdownLink+"'");});return result;};const showMessagesPopup=(messagePack)=>{log(">>> showMessagesPopup");const massageAll=messagePack.messages.join("\n");log("showMessagesPopup | messagePack.messages.length "+messagePack.messages.length);log("showMessagesPopup | massageAll.length "+massageAll.length);const textareaElement=document.createElement("textarea");textareaElement.rows=10;textareaElement.cols=50;textareaElement.textContent=massageAll;const win=window.open("","Slack messages","toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,height=300,top="+(screen.height-200)+",left="+(screen.width-200));win.document.body.appendChild(textareaElement);return true;};const exportMessage=()=>{log(">>> exportMessage");const messagePack={messages:[],messageSet:new Set(),messagePushed:false,hasNextPage:true,};getMessage(messagePack);};exportMessage();})();
