# Task 6.4: プログレス表示機能 手動テスト手順書

## テスト目的

Task 6.4の統合テスト要件を満たすため、実際のSlack環境でプログレス表示機能が正しく動作することを手動で検証します。

## 前提条件

- Chrome拡張機能がビルドされている(`npm run build`実行済み)
- Chromeブラウザに拡張機能がインストールされている
- Slackワークスペースへのログイン資格情報

## テスト環境準備

### 1. 拡張機能のインストール

```bash
cd /Users/yaar/Playground/slack-search-result-exporter
npm run build
```

Chrome拡張機能管理ページ(`chrome://extensions/`)を開く:
1. 「デベロッパーモード」を有効化
2. 「パッケージ化されていない拡張機能を読み込む」をクリック
3. `dist/`ディレクトリを選択

### 2. Slackへのログイン

1. `https://app.slack.com/client/T04JTC862/search`にアクセス
2. ワークスペースにログイン
3. 検索結果ページが表示されることを確認

## テストケース

### TC 6.4.1: Content Script → Popup プログレスメッセージングフロー

**目的**: Content ScriptからPopupへのEXPORT_PROGRESSメッセージが正しく送信・受信されることを確認

**手順**:
1. Slack検索結果ページ(`https://app.slack.com/client/T04JTC862/search`)を開く
2. 検索クエリを入力して検索を実行(複数ページの結果が出るクエリを使用)
3. Chrome拡張機能のPopupを開く
4. 「エクスポート」ボタンをクリック
5. Popup UI内のプログレス表示を観察

**期待結果**:
- ✓ `#progress`要素が表示される
- ✓ `#progress-text`に「ページ X 処理中 (Y メッセージ)」が表示される
- ✓ 処理段階に応じて以下のテキストが表示される:
  - 「DOM読み込み待機中...」
  - 「メッセージ抽出中...」
  - 「次ページへ移動中...」
- ✓ ページ数とメッセージ数が動的に更新される
- ✓ スピナーアニメーションが表示され続ける

**合格基準**: すべての期待結果が確認できること

---

### TC 6.4.2: 複数ページエクスポート時のプログレス更新シーケンス

**目的**: 複数ページのエクスポート処理中、プログレス情報が正しく更新されることを確認

**手順**:
1. Slack検索で3ページ以上の結果が出るクエリを実行
   - 例: `from:@username after:2024-01-01`
2. 拡張機能Popupを開く
3. エクスポートを開始
4. 各ページ処理中のプログレステキストを記録

**期待結果**:
- ✓ ページ1処理中: 「ページ 1 処理中 (X メッセージ) - DOM読み込み待機中...」
- ✓ ページ1処理中: 「ページ 1 処理中 (Y メッセージ) - メッセージ抽出中...」
- ✓ ページ1→2遷移: 「ページ 1 処理中 (Y メッセージ) - 次ページへ移動中...」
- ✓ ページ2処理中: 「ページ 2 処理中 (Z メッセージ) - DOM読み込み待機中...」
- ✓ ... (各ページで同様のシーケンス)
- ✓ メッセージ数が累積増加する
- ✓ エクスポート完了後、`#progress`が非表示になり`#result-section`が表示される

**合格基準**: 各ページの処理段階が正しく表示され、メッセージ数が累積されること

---

### TC 6.4.3: runtime.sendMessage()失敗時の処理継続確認

**目的**: プログレスメッセージ送信失敗時もエクスポート処理が継続されることを確認

**手順**:
1. Chrome DevToolsを開く
2. Consoleタブを表示
3. 以下のコードをConsoleに貼り付けて実行(runtime.sendMessageをモック):
```javascript
// Save original
const originalSendMessage = chrome.runtime.sendMessage;
// Mock to throw error
chrome.runtime.sendMessage = function() {
  throw new Error('Mock runtime.sendMessage error');
};
```
4. 拡張機能Popupでエクスポートを実行
5. Consoleログを確認

**期待結果**:
- ✓ Console に "Progress message send failed" 警告が表示される
- ✓ エクスポート処理が継続され、最終的にEXPORT_COMPLETEが返される
- ✓ エラーがスローされず、処理が中断しない

**後処理**:
```javascript
// Restore original
chrome.runtime.sendMessage = originalSendMessage;
```

**合格基準**: メッセージ送信失敗時も処理が継続し、完了すること

---

### TC 6.4.4: プログレス表示のパフォーマンス検証

**目的**: プログレスメッセージ送信のオーバーヘッドが要件5.1(< 50ms/ページ)を満たすことを確認

**手順**:
1. Chrome DevTools > Performanceタブを開く
2. 記録を開始
3. 複数ページのエクスポートを実行
4. 記録を停止
5. タイムラインでsendProgress()呼び出しを検索
6. 各呼び出しの実行時間を測定

**期待結果**:
- ✓ sendProgress()の実行時間: < 10ms/回
- ✓ 1ページあたりの総プログレスオーバーヘッド: < 50ms (3回 × < 10ms)

**合格基準**: 各ページのプログレスメッセージング総オーバーヘッドが50ms未満

---

## リグレッションテスト(Task 6.5)

### TC 6.5.1: 既存EXPORT_COMPLETE機能の維持

**手順**:
1. エクスポートを実行
2. 完了後、`#result-section`の内容を確認

**期待結果**:
- ✓ メッセージ数が正しく表示される
- ✓ TSV形式のデータが`#result-text`に表示される
- ✓ タブ区切りで4カラム(timestamp, channel, sender, content)

**合格基準**: 既存の完了メッセージ表示が正常動作

---

### TC 6.5.2: 日付プリセット適用機能の維持

**手順**:
1. Popup UIで日付プリセット(例: "yesterday")を選択
2. プリセット適用後、エクスポートが自動開始されるか確認

**期待結果**:
- ✓ プリセット選択後、エクスポートが自動開始される
- ✓ APPLY_DATE_PRESETメッセージが正常に処理される
- ✓ エクスポート結果が正しく表示される

**合格基準**: 日付プリセット機能が正常動作

---

### TC 6.5.3: エラーハンドリングの維持

**手順**:
1. Slack以外のページ(例: `https://example.com`)を開く
2. 拡張機能Popupを開く
3. エクスポートボタンをクリック

**期待結果**:
- ✓ `#error-message`が表示される
- ✓ エラーメッセージに「Slack」が含まれる
- ✓ 部分データがある場合は保持される

**合格基準**: 既存のエラーハンドリングが正常動作

---

## テスト結果記録

| テストケース | 実行日 | 結果 | 備考 |
|------------|--------|------|------|
| TC 6.4.1   |        |      |      |
| TC 6.4.2   |        |      |      |
| TC 6.4.3   |        |      |      |
| TC 6.4.4   |        |      |      |
| TC 6.5.1   |        |      |      |
| TC 6.5.2   |        |      |      |
| TC 6.5.3   |        |      |      |

## 既知の制限事項

1. **自動E2Eテストの非実装**: Slack認証の複雑さとメンテナンスコストのため、完全な自動E2Eテストは手動テストに置き換えています
2. **ページ数の可変性**: Slack検索結果のページ数は動的に変わるため、テスト時は3ページ以上の結果が出るクエリを選択してください

## トラブルシューティング

### プログレス表示が更新されない場合

1. Chrome DevTools > Consoleでエラーを確認
2. Content Scriptが正しくインジェクトされているか確認(`chrome.runtime`が利用可能か)
3. 拡張機能を再読み込み(`chrome://extensions/`で「再読み込み」ボタン)

### エクスポートが完了しない場合

1. Slack検索結果ページのDOM構造が変更されていないか確認
2. ページネーションボタンが存在するか確認
3. Content Script Consoleで詳細ログを確認

## 参考資料

- 要件ドキュメント: `.kiro/specs/progress-display/requirements.md`
- 設計ドキュメント: `.kiro/specs/progress-display/design.md`
- 実装タスク: `.kiro/specs/progress-display/tasks.md`
